name: Daily Mod Update and Release Pipeline

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force create all enabled versions (ignore update check)'
        required: false
        type: boolean
        default: false
      versions:
        description: 'Comma-separated versions to process (override config, e.g., 1.21.5,1.21.8)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  actions: read

concurrency:
  group: daily-mod-update-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Validate and update mod database
  update-database:
    runs-on: windows-latest
    outputs:
      has_updates: ${{ steps.check_updates.outputs.has_updates }}
      versions_matrix: ${{ steps.set_matrix.outputs.matrix }}
      next_game_version: ${{ steps.get_next_latest_versions.outputs.next_game_version }}
      latest_game_version: ${{ steps.get_next_latest_versions.outputs.latest_game_version }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2  # Need previous commit to compare

      - name: Sync latest Minecraft version (server, launcher, installer)
        shell: pwsh
        run: |
          Write-Host "ðŸ”„ Ensuring latest MC version has server, launcher, installer in DB..." -ForegroundColor Cyan
          .\ModManager.ps1 -SyncLatestMinecraftVersion
      
      - name: Validate Mod Versions
        shell: pwsh
        run: |
          Write-Host "ðŸ” Checking for mod updates..." -ForegroundColor Cyan
          .\ModManager.ps1 -ValidateAllModVersions -UpdateModList

      - name: Refresh Next version data only
        shell: pwsh
        run: |
          Write-Host "ðŸ”„ Refreshing Next version fields from APIs (Current/Latest unchanged)..." -ForegroundColor Cyan
          .\ModManager.ps1 -ValidateAllModVersions -UpdateNextOnly

      - name: Refresh Latest version data only
        shell: pwsh
        run: |
          Write-Host "ðŸ”„ Refreshing Latest version fields from APIs (Current/Next unchanged)..." -ForegroundColor Cyan
          .\ModManager.ps1 -ValidateAllModVersions -UpdateLatestOnly

      - name: Get Next and Latest game versions
        id: get_next_latest_versions
        shell: pwsh
        run: |
          . .\src\Data\Version\Get-NextVersion.ps1
          . .\src\Data\Version\Get-LatestVersion.ps1
          $next = Get-NextVersion -CsvPath modlist.csv
          $latest = Get-LatestVersion -CsvPath modlist.csv
          if ($next) { echo "next_game_version=$next" >> $env:GITHUB_OUTPUT } else { echo "next_game_version=" >> $env:GITHUB_OUTPUT }
          if ($latest) { echo "latest_game_version=$latest" >> $env:GITHUB_OUTPUT } else { echo "latest_game_version=" >> $env:GITHUB_OUTPUT }
          Write-Host "Next game version: $next | Latest game version: $latest" -ForegroundColor Gray

      - name: Scan Database for Misclassified ZIP Mods
        shell: pwsh
        run: |
          $db = Import-Csv modlist.csv
          $zipMods = $db | Where-Object { $_.Type -eq 'mod' -and (([string]::IsNullOrWhiteSpace($_.Jar) -eq $false -and $_.Jar.ToLower().EndsWith('.zip')) -or ($_.CurrentVersionUrl -match '\.zip$') -or ($_.LatestVersionUrl -match '\.zip$') -or ($_.NextVersionUrl -match '\.zip$')) }
          if ($zipMods -and $zipMods.Count -gt 0) {
            Write-Host "âš ï¸  Found mods with ZIP artifacts (likely misclassification or filename resolution issue):" -ForegroundColor Yellow
            foreach ($m in $zipMods) {
              $id = if ($m.ID) { $m.ID } else { $m.Name }
              $jar = if ($m.Jar) { $m.Jar } else { '(none)' }
              echo "::warning title=ZIP artifact under mod type::$($m.Name) [ID: $id] -> Jar: $jar"
            }
            # Add to summary
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "### ZIP Artifacts Detected in Database (Type=mod)"
            $zipMods | ForEach-Object { Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "- $($_.Name) (ID: $($_.ID)) Jar: $($_.Jar)" }
            Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          } else {
            Write-Host "âœ… No misclassified ZIP mods found in database" -ForegroundColor Green
          }
      
      - name: Check for Database Changes
        id: check_updates
        shell: pwsh
        run: |
          git diff --quiet modlist.csv
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ðŸ“¦ Mod updates detected in database" -ForegroundColor Green
            
            # Show what changed
            Write-Host "ðŸ“Š Changes summary:" -ForegroundColor Cyan
            git diff --stat modlist.csv
            
            echo "has_updates=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âœ… No mod updates found" -ForegroundColor Gray
            echo "has_updates=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Read Enabled Versions from Config
        id: set_matrix
        shell: pwsh
        run: |
          # Read optional override from workflow_dispatch input
          $override = "${{ github.event.inputs.versions }}"

          if ([string]::IsNullOrWhiteSpace($override)) {
            # Use config file when no override provided
            $config = Get-Content release-config.json | ConvertFrom-Json
            $versions = $config.versions | Where-Object { $_.enabled -eq $true } | Select-Object -ExpandProperty version
            Write-Host "â„¹ï¸  No versions override provided; using enabled versions from release-config.json" -ForegroundColor Yellow
          } else {
            # Split comma-separated list and trim
            $versions = $override.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { $_ }
            Write-Host "ðŸ”§ Using manual version override from dispatch input: $override" -ForegroundColor Cyan
          }

          # Ensure output is always a JSON array (even for single item)
          if ($versions.Count -eq 1) {
            $matrixJson = "[$($versions | ConvertTo-Json -Compress)]"
          } else {
            $matrixJson = $versions | ConvertTo-Json -Compress
          }

          echo "matrix=$matrixJson" >> $env:GITHUB_OUTPUT

          Write-Host "ðŸ“‹ Versions selected for release:" -ForegroundColor Cyan
          $versions | ForEach-Object { Write-Host "   - $_" -ForegroundColor Gray }
          Write-Host "ðŸ“Š Matrix JSON: $matrixJson" -ForegroundColor Gray
      
      - name: Log No Updates
        if: steps.check_updates.outputs.has_updates != 'true'
        shell: pwsh
        run: |
          Write-Host "" -ForegroundColor White
          Write-Host "â„¹ï¸  ============================================" -ForegroundColor Cyan
          Write-Host "â„¹ï¸  NO MOD UPDATES DETECTED" -ForegroundColor Cyan
          Write-Host "â„¹ï¸  ============================================" -ForegroundColor Cyan
          Write-Host "" -ForegroundColor White
          Write-Host "ðŸ“‹ Workflow will skip:" -ForegroundColor Yellow
          Write-Host "   â€¢ Commit Database Updates (no changes to commit)" -ForegroundColor Gray
          Write-Host "   â€¢ Create Release Packages (database unchanged)" -ForegroundColor Gray
          Write-Host "   â€¢ Publish Release (no new packages)" -ForegroundColor Gray
          Write-Host "" -ForegroundColor White
          Write-Host "ðŸ’¡ This is normal behavior when mods are up-to-date" -ForegroundColor Green
          Write-Host "" -ForegroundColor White
      
      - name: Commit Database Updates
        if: steps.check_updates.outputs.has_updates == 'true'
        shell: pwsh
        run: |
          Write-Host "ðŸ’¾ Committing database updates..." -ForegroundColor Cyan
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add modlist.csv
          git commit -m "chore: Daily mod update - $(Get-Date -Format 'yyyy-MM-dd')"
          git push
          Write-Host "âœ… Database changes committed and pushed" -ForegroundColor Green
  
  # Job 2: Create release packages for enabled versions
  create-releases:
    needs: update-database
    # Run if: updates detected OR manual force
    if: |
      needs.update-database.outputs.has_updates == 'true' || 
      github.event.inputs.force_all == 'true'
    
    runs-on: windows-latest
    timeout-minutes: 120
    env:
      CURSEFORGE_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
      MINECRAFT_SERVER_URL: ${{ secrets.MINECRAFT_SERVER_URL }}
      FABRIC_SERVER_URL: ${{ secrets.FABRIC_SERVER_URL }}
    strategy:
      matrix:
        version: ${{ fromJson(needs.update-database.outputs.versions_matrix) }}
      fail-fast: false  # Continue even if one version fails
      max-parallel: 3   # Limit parallel builds
    
    steps:
      - name: Checkout Repository with Submodules
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest with updated modlist.csv
          submodules: true  # Clone minecraft-mod-hash submodule
      
      - name: Create Release Package for ${{ matrix.version }}
        id: create_release
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "ðŸš€ Creating release package for Minecraft ${{ matrix.version }}" -ForegroundColor Cyan
          Write-Host "=================================================" -ForegroundColor Cyan
          Write-Host ""
          
          # This will:
          # 1. Download mods for the version
          # 2. Download server files
          # 3. Validate by starting the server
          # 4. Organize mods (mandatory/optional)
          # 5. Generate hashes and documentation
          # 6. Create ZIP package
          # 7. Exit 0 if successful, 1 if server validation fails
          
          .\ModManager.ps1 -CreateRelease -GameVersion "${{ matrix.version }}"
      
      - name: Check Release Creation Result
        id: check_result
        shell: pwsh
        run: |
          if ("${{ steps.create_release.outcome }}" -eq "success") {
            Write-Host "âœ… Version ${{ matrix.version }}: Release created successfully" -ForegroundColor Green
            echo "created=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âŒ Version ${{ matrix.version }}: Server validation failed - no release created" -ForegroundColor Red
            echo "created=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Cleanup Duplicate Modpack Files
        if: steps.check_result.outputs.created == 'true'
        shell: pwsh
        run: |
          $releasePath = "releases/${{ matrix.version }}"
          $modpackFiles = Get-ChildItem -Path $releasePath -Filter "modpack.*" -File -ErrorAction SilentlyContinue
          foreach ($file in $modpackFiles) {
            Remove-Item -Path $file.FullName -Force
            Write-Host "âœ“ Removed: $($file.Name)" -ForegroundColor Green
          }
          if ($modpackFiles.Count -gt 0) {
            Write-Host "âœ“ Cleaned up $($modpackFiles.Count) modpack file(s)" -ForegroundColor Green
          }
      
      - name: Copy Server JARs to Release
        if: steps.check_result.outputs.created == 'true'
        shell: pwsh
        run: |
          $version = "${{ matrix.version }}"
          $serverPath = "download/$version"
          $releasePath = "releases/$version"
          
          Write-Host "ðŸ“¦ Copying server JARs to release folder..." -ForegroundColor Cyan
          
          # Create release directory if it doesn't exist
          if (-not (Test-Path $releasePath)) {
            New-Item -ItemType Directory -Path $releasePath -Force | Out-Null
            Write-Host "  âœ“ Created release directory: $releasePath" -ForegroundColor Green
          }
          
          # Copy Minecraft server JAR
          $minecraftJar = Get-ChildItem -Path $serverPath -Filter "minecraft_server*.jar" -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($minecraftJar) {
            Copy-Item -Path $minecraftJar.FullName -Destination $releasePath -Force
            Write-Host "  âœ“ Copied: $($minecraftJar.Name)" -ForegroundColor Green
          } else {
            Write-Host "  âš ï¸  Warning: Minecraft server JAR not found" -ForegroundColor Yellow
          }
          
          # Copy Fabric launcher JAR
          $fabricJar = Get-ChildItem -Path $serverPath -Filter "fabric-server*.jar" -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($fabricJar) {
            Copy-Item -Path $fabricJar.FullName -Destination $releasePath -Force
            Write-Host "  âœ“ Copied: $($fabricJar.Name)" -ForegroundColor Green
          } else {
            Write-Host "  âš ï¸  Warning: Fabric launcher JAR not found" -ForegroundColor Yellow
          }
          
          # Copy Fabric installer
          $installerPath = Join-Path $serverPath "installer"
          if (Test-Path $installerPath) {
            $fabricInstaller = Get-ChildItem -Path $installerPath -Filter "fabric-installer-*.exe" -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($fabricInstaller) {
              Copy-Item -Path $fabricInstaller.FullName -Destination $releasePath -Force
              Write-Host "  âœ“ Copied: $($fabricInstaller.Name)" -ForegroundColor Green
            } else {
              Write-Host "  âš ï¸  Warning: Fabric installer not found" -ForegroundColor Yellow
            }
          } else {
            Write-Host "  âš ï¸  Warning: Installer directory not found" -ForegroundColor Yellow
          }

      - name: Verify Required Files (hash.txt, README.md)
        if: steps.check_result.outputs.created == 'true'
        shell: pwsh
        run: |
          $version = "${{ matrix.version }}"
          $releasePath = "releases/$version"

          $hashFile = Join-Path $releasePath 'hash.txt'
          $readmeFile = Join-Path $releasePath 'README.md'

          $missing = @()
          if (-not (Test-Path $hashFile)) { $missing += 'hash.txt' }
          if (-not (Test-Path $readmeFile)) { $missing += 'README.md' }

          if ($missing.Count -eq 0) {
            Write-Host "âœ… Required files present: hash.txt, README.md" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸  Missing required files: $($missing -join ', ') â€” generating minimal fallbacks" -ForegroundColor Yellow
            if ($missing -contains 'hash.txt') {
              "# Hashes placeholder â€” generated by workflow`n# Actual hashes should be provided by ModManager during release creation" | Out-File -FilePath $hashFile -Encoding UTF8 -Force
            }
            if ($missing -contains 'README.md') {
              @(
                "# Modpack ${version}",
                "",
                "This README was generated as a fallback by the CI workflow.",
                "For full instructions, see the project's documentation.",
                "",
                "Contents:",
                "- mods/ (mandatory)",
                "- mods/optional/ (optional)",
                "- server JARs (minecraft_server*, fabric-server*, installer)"
              ) | Out-File -FilePath $readmeFile -Encoding UTF8 -Force
            }
          }
      
      - name: Upload Release Artifact
        if: steps.check_result.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: modpack-${{ matrix.version }}
          path: releases/${{ matrix.version }}/**
          retention-days: 90
          compression-level: 0  # Files already compressed in ZIP
      
      - name: Log Validation Failure
        if: steps.check_result.outputs.created == 'false'
        shell: pwsh
        run: |
          Write-Host "âŒ Release package NOT created for version ${{ matrix.version }}" -ForegroundColor Red
          Write-Host "ðŸ’¡ Server validation failed - check logs for mod compatibility issues" -ForegroundColor Yellow

  # Job 2b: Build and validate Next/Latest version packages (if valid, they are added to release)
  create-next-latest-releases:
    needs: update-database
    if: |
      (needs.update-database.outputs.has_updates == 'true' || github.event.inputs.force_all == 'true') &&
      (needs.update-database.outputs.next_game_version != '' || needs.update-database.outputs.latest_game_version != '')
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      CURSEFORGE_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
      MINECRAFT_SERVER_URL: ${{ secrets.MINECRAFT_SERVER_URL }}
      FABRIC_SERVER_URL: ${{ secrets.FABRIC_SERVER_URL }}
    
    steps:
      - name: Checkout Repository with Submodules
        uses: actions/checkout@v4
        with:
          ref: main
          submodules: true

      - name: Create Release Package for Next version
        if: needs.update-database.outputs.next_game_version != ''
        id: create_next
        shell: pwsh
        continue-on-error: true
        run: |
          $ver = "${{ needs.update-database.outputs.next_game_version }}"
          Write-Host "ðŸš€ Creating release package for Next version (Minecraft $ver)..." -ForegroundColor Cyan
          .\ModManager.ps1 -CreateRelease -GameVersion $ver
          if ($LASTEXITCODE -eq 0) {
            echo "created=true" >> $env:GITHUB_OUTPUT
            echo "version=$ver" >> $env:GITHUB_OUTPUT
          } else {
            echo "created=false" >> $env:GITHUB_OUTPUT
          }

      - name: Upload Next version release artifact
        if: needs.update-database.outputs.next_game_version != '' && steps.create_next.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: modpack-next-${{ needs.update-database.outputs.next_game_version }}
          path: releases/${{ needs.update-database.outputs.next_game_version }}/**
          retention-days: 90
          compression-level: 0

      - name: Create Release Package for Latest version
        if: needs.update-database.outputs.latest_game_version != ''
        id: create_latest
        shell: pwsh
        continue-on-error: true
        run: |
          $ver = "${{ needs.update-database.outputs.latest_game_version }}"
          Write-Host "ðŸš€ Creating release package for Latest version (Minecraft $ver)..." -ForegroundColor Cyan
          .\ModManager.ps1 -CreateRelease -GameVersion $ver
          if ($LASTEXITCODE -eq 0) {
            echo "created=true" >> $env:GITHUB_OUTPUT
            echo "version=$ver" >> $env:GITHUB_OUTPUT
          } else {
            echo "created=false" >> $env:GITHUB_OUTPUT
          }

      - name: Upload Latest version release artifact
        if: needs.update-database.outputs.latest_game_version != '' && steps.create_latest.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: modpack-latest-${{ needs.update-database.outputs.latest_game_version }}
          path: releases/${{ needs.update-database.outputs.latest_game_version }}/**
          retention-days: 90
          compression-level: 0
  
  # Job 3: Create GitHub Release with artifacts
  publish-release:
    needs: [update-database, create-releases]
    if: needs.create-releases.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.release_info.outputs.tag }}
      timestamp: ${{ steps.release_info.outputs.timestamp }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Package Release Files
        shell: bash
        run: |
          echo "ðŸ“¦ Creating versioned release packages..."
          
          # For each artifact directory (modpack-1.21.5, modpack-1.21.8, etc.)
          for artifact_dir in artifacts/modpack-*/; do
            if [ -d "$artifact_dir" ]; then
              # Extract version from directory name (modpack-1.21.5 -> 1.21.5)
              version=$(basename "$artifact_dir" | sed 's/modpack-//')
              echo "  Processing version: $version"
              
              # Copy README.md to root as separate file (README.md is generated by hash.ps1 in releases/{version}/)
              # Artifact structure: artifacts/modpack-{version}/ contains all files from releases/{version}/
              readme_src="$artifact_dir/README.md"
              readme_dest="README-${version}.md"
              if [ -f "$readme_src" ]; then
                cp "$readme_src" "$readme_dest"
                echo "    âœ“ Extracted README.md â†’ $readme_dest"
              else
                echo "    âš ï¸  Warning: README.md not found in artifact for $version"
              fi
              
              # Create versioned zip from all files in the directory
              cd "$artifact_dir"
              zip -r "../../modpack-$version.zip" *
              cd ../..
              
              echo "    âœ“ Created modpack-$version.zip"
            fi
          done
          
          echo "âœ… All release packages created"

      - name: Generate Checksums
        shell: bash
        run: |
          set -e
          shopt -s nullglob
          files=(modpack-*.zip)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No packaged ZIPs found; nothing to checksum."
            exit 0
          fi
          echo "ðŸ“ Computing SHA256 checksums..."
          sha256sum "${files[@]}" > release-hashes.txt
          echo "âœ“ Wrote release-hashes.txt"
      
      - name: Generate Release Tag and Notes
        id: release_info
        shell: bash
        run: |
          # Generate timestamp-based tag
          TIMESTAMP=$(date -u '+%Y.%m.%d-%H%M%S')
          TAG="release-${TIMESTAMP}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          
          # Generate release notes
          shopt -s nullglob
          INCLUDED_FILES=(modpack-*.zip)

          {
            echo "> âš ï¸ **PRE-RELEASE**: This is an automated development build."
            echo "> For stable releases, see tagged releases (created from Git tags)."
            echo
            echo "# Minecraft Modpack Release - ${TIMESTAMP}"
            echo
            echo "## ðŸ“¦ Included Packages"
            if [ ${#INCLUDED_FILES[@]} -eq 0 ]; then
              echo "- (none)"
            else
              for f in "${INCLUDED_FILES[@]}"; do
                echo "- **$f**"
              done
            fi
            echo
            echo "## ðŸ“‹ Changes"
            echo "- Mod database updated: ${{ needs.update-database.outputs.has_updates }}"
            echo "- Server validation: Successful for packaged versions"
            echo "- Next/Latest version packages (modpack-next-*, modpack-latest-*) included when validation passed"
            echo
            echo "## ðŸ”‘ Checksums"
            if [ -f release-hashes.txt ]; then
              echo '\n```'
              cat release-hashes.txt
              echo '```\n'
            else
              echo "(checksums unavailable)"
            fi
            echo
            echo "## ðŸ“¥ Download Instructions"
            echo
            echo "1. Download \`modpack-[version].zip\` for your Minecraft version"
            echo "2. Extract the ZIP file"
            echo "3. Install mods from the \`mods/\` directory to \`.minecraft/mods/\`"
            echo "4. Optional mods are in \`mods/optional/\`"
            echo "5. Check \`hash.txt\` for file verification"
            echo "6. See \`README.md\` for complete installation guide"
            echo
            echo "## â„¹ï¸ Release Information"
            echo
            echo "- **Created**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Workflow**: Daily Mod Update Pipeline"
            echo "- **Validation**: Server startup tested for each packaged version"
            echo
            echo "## ðŸ”— InertiaAntiCheat Integration"
            echo
            echo "Use included \`hash.txt\` to configure InertiaAntiCheat server validation."
            echo "See \`README.md\` for details."
          } > release-notes.md

          echo "Generated release-notes.md:" && cat release-notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_info.outputs.tag }}
          name: Modpack Release ${{ steps.release_info.outputs.timestamp }}
          body_path: release-notes.md
          draft: false
          prerelease: true  # Automated releases are pre-releases (tag-based releases are stable)
          files: |
            modpack-*.zip
            release-hashes.txt
            README-*.md
  
  # Job 4: Summary report
  summary:
    needs: [update-database, create-releases, publish-release]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Pipeline Summary
        shell: bash
        run: |
          echo "## Daily Mod Update and Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mod Updates Detected:** ${{ needs.update-database.outputs.has_updates }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show why stages were skipped if no updates
          if [ "${{ needs.update-database.outputs.has_updates }}" != "true" ]; then
            echo "### â„¹ï¸ No Updates Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The mod database is already up-to-date. The following stages were skipped:" >> $GITHUB_STEP_SUMMARY
            echo "- â­ï¸ **Create Release Packages** - No database changes to package" >> $GITHUB_STEP_SUMMARY
            echo "- â­ï¸ **Publish Release** - No new packages to publish" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ This is expected behavior when all mods are at their latest versions." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "**Enabled Versions:** $(echo '${{ needs.update-database.outputs.versions_matrix }}' | jq -r '. | join(", ")')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.create-releases.result }}" == "success" ]; then
            echo "âœ… **Release Creation:** Completed successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.create-releases.result }}" == "skipped" ]; then
            echo "â­ï¸ **Release Creation:** Skipped (no updates)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Release Creation:** Some versions failed server validation" >> $GITHUB_STEP_SUMMARY
          fi
          echo "**Next/Latest packages:** Built and added to release when server validation passes (Next: ${{ needs.update-database.outputs.next_game_version }}, Latest: ${{ needs.update-database.outputs.latest_game_version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.publish-release.result }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **GitHub Release:** Published successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”— **Release Tag:** \`${{ needs.publish-release.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ·ï¸ **Timestamp:** ${{ needs.publish-release.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.publish-release.result }}" == "skipped" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ **GitHub Release:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Run:** Tomorrow at 2:00 AM UTC" >> $GITHUB_STEP_SUMMARY 