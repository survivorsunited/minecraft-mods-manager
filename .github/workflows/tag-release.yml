name: Tag-Based Release

on:
  push:
    tags:
      - 'v*'        # Semantic versioning: v1.0.0, v1.1.0, v2.0.0
      - 'release-*' # Date-based: release-2025.11.18

permissions:
  contents: write
  actions: read

concurrency:
  group: tag-release-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel - tag releases are important

jobs:
  create-release:
    runs-on: windows-latest
    timeout-minutes: 120
    env:
      CURSEFORGE_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
      MINECRAFT_SERVER_URL: ${{ secrets.MINECRAFT_SERVER_URL }}
      FABRIC_SERVER_URL: ${{ secrets.FABRIC_SERVER_URL }}
    
    steps:
      - name: Checkout Repository with Submodules
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          submodules: true
      
      - name: Extract Tag Information
        id: tag_info
        shell: pwsh
        run: |
          $tagRef = "${{ github.ref }}"
          $tagName = $tagRef -replace 'refs/tags/', ''
          
          # Extract version from tag (remove 'v' prefix if present)
          $version = $tagName
          if ($tagName -match '^v(.+)$') {
            $version = $matches[1]
          } elseif ($tagName -match '^release-(.+)$') {
            $version = $matches[1]
          }
          
          Write-Host "Tag Name: $tagName" -ForegroundColor Cyan
          Write-Host "Extracted Version: $version" -ForegroundColor Cyan
          
          echo "tag_name=$tagName" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
      
      - name: Read Enabled Versions from Config
        id: set_versions
        shell: pwsh
        run: |
          $config = Get-Content release-config.json | ConvertFrom-Json
          $enabledVersions = $config.versions | Where-Object { $_.enabled -eq $true } | Select-Object -ExpandProperty version
          
          if ($enabledVersions.Count -eq 1) {
            $matrixJson = "[$($enabledVersions | ConvertTo-Json -Compress)]"
          } else {
            $matrixJson = $enabledVersions | ConvertTo-Json -Compress
          }
          
          echo "versions=$matrixJson" >> $env:GITHUB_OUTPUT
          Write-Host "Enabled versions: $($enabledVersions -join ', ')" -ForegroundColor Cyan
      
      - name: Create Release Packages (All Enabled Versions)
        shell: pwsh
        run: |
          $versionsJson = '${{ steps.set_versions.outputs.versions }}'
          $versions = ($versionsJson | ConvertFrom-Json)
          
          Write-Host "üöÄ Creating release packages for tag: ${{ steps.tag_info.outputs.tag_name }}" -ForegroundColor Cyan
          Write-Host "üì¶ Enabled versions: $($versions -join ', ')" -ForegroundColor Cyan
          Write-Host ""
          
          foreach ($v in $versions) {
            Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Gray
            Write-Host "Creating release package for Minecraft $v" -ForegroundColor Cyan
            Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" -ForegroundColor Gray
            Write-Host ""
            
            # This will:
            # 1. Download mods for the version
            # 2. Download server files
            # 3. Validate by starting the server
            # 4. Organize mods (mandatory/optional)
            # 5. Generate hashes and documentation
            # 6. Create ZIP package
            # 7. Exit 0 if successful, 1 if server validation fails
            
            .\ModManager.ps1 -CreateRelease -GameVersion $v
            
            if ($LASTEXITCODE -ne 0) {
              Write-Host "‚ùå Release creation failed for version $v" -ForegroundColor Red
              exit 1
            }
            
            Write-Host "‚úÖ Release package created for version $v" -ForegroundColor Green
            Write-Host ""
          }
      
      - name: Cleanup Duplicate Modpack Files
        shell: pwsh
        run: |
          $versionsJson = '${{ steps.set_versions.outputs.versions }}'
          $versions = ($versionsJson | ConvertFrom-Json)
          
          foreach ($v in $versions) {
            $releasePath = "releases/$v"
            $modpackFiles = Get-ChildItem -Path $releasePath -Filter "modpack.*" -File -ErrorAction SilentlyContinue
            foreach ($file in $modpackFiles) {
              Remove-Item -Path $file.FullName -Force
              Write-Host "‚úì Removed: $($file.Name)" -ForegroundColor Green
            }
            if ($modpackFiles.Count -gt 0) {
              Write-Host "‚úì Cleaned up $($modpackFiles.Count) modpack file(s) for $v" -ForegroundColor Green
            }
          }
      
      - name: Copy Server JARs to Release
        shell: pwsh
        run: |
          $versionsJson = '${{ steps.set_versions.outputs.versions }}'
          $versions = ($versionsJson | ConvertFrom-Json)
          
          foreach ($v in $versions) {
            $serverPath = "download/$v"
            $releasePath = "releases/$v"
            
            Write-Host "üì¶ Copying server JARs to release folder for $v..." -ForegroundColor Cyan
            
            # Create release directory if it doesn't exist
            if (-not (Test-Path $releasePath)) {
              New-Item -ItemType Directory -Path $releasePath -Force | Out-Null
              Write-Host "  ‚úì Created release directory: $releasePath" -ForegroundColor Green
            }
            
            # Copy Minecraft server JAR
            $minecraftJar = Get-ChildItem -Path $serverPath -Filter "minecraft_server*.jar" -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($minecraftJar) {
              Copy-Item -Path $minecraftJar.FullName -Destination $releasePath -Force
              Write-Host "  ‚úì Copied: $($minecraftJar.Name)" -ForegroundColor Green
            } else {
              Write-Host "  ‚ö†Ô∏è  Warning: Minecraft server JAR not found" -ForegroundColor Yellow
            }
            
            # Copy Fabric launcher JAR
            $fabricJar = Get-ChildItem -Path $serverPath -Filter "fabric-server*.jar" -File -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($fabricJar) {
              Copy-Item -Path $fabricJar.FullName -Destination $releasePath -Force
              Write-Host "  ‚úì Copied: $($fabricJar.Name)" -ForegroundColor Green
            } else {
              Write-Host "  ‚ö†Ô∏è  Warning: Fabric launcher JAR not found" -ForegroundColor Yellow
            }
            
            # Copy Fabric installer
            $installerPath = Join-Path $serverPath "installer"
            if (Test-Path $installerPath) {
              $fabricInstallerExe = Get-ChildItem -Path $installerPath -Filter "fabric-installer-*.exe" -File -ErrorAction SilentlyContinue | Select-Object -First 1
              $fabricInstallerJar = Get-ChildItem -Path $installerPath -Filter "fabric-installer-*.jar" -File -ErrorAction SilentlyContinue | Select-Object -First 1
              
              if ($fabricInstallerExe) {
                Copy-Item -Path $fabricInstallerExe.FullName -Destination $releasePath -Force
                Write-Host "  ‚úì Copied: $($fabricInstallerExe.Name)" -ForegroundColor Green
              }
              if ($fabricInstallerJar) {
                Copy-Item -Path $fabricInstallerJar.FullName -Destination $releasePath -Force
                Write-Host "  ‚úì Copied: $($fabricInstallerJar.Name)" -ForegroundColor Green
              }
              
              if (-not $fabricInstallerExe -and -not $fabricInstallerJar) {
                Write-Host "  ‚ö†Ô∏è  Warning: Fabric installer not found" -ForegroundColor Yellow
              }
            } else {
              Write-Host "  ‚ö†Ô∏è  Warning: Installer directory not found" -ForegroundColor Yellow
            }
          }
      
      - name: Verify Required Files (hash.txt, README.md)
        shell: pwsh
        run: |
          $versionsJson = '${{ steps.set_versions.outputs.versions }}'
          $versions = ($versionsJson | ConvertFrom-Json)
          
          foreach ($v in $versions) {
            $releasePath = "releases/$v"
            $hashFile = Join-Path $releasePath 'hash.txt'
            $readmeFile = Join-Path $releasePath 'README.md'
            
            $missing = @()
            if (-not (Test-Path $hashFile)) { $missing += 'hash.txt' }
            if (-not (Test-Path $readmeFile)) { $missing += 'README.md' }
            
            if ($missing.Count -eq 0) {
              Write-Host "‚úÖ Required files present for $v - hash.txt, README.md" -ForegroundColor Green
            } else {
              Write-Host "‚ö†Ô∏è  Missing required files for $v - $($missing -join ', ') ‚Äî generating minimal fallbacks" -ForegroundColor Yellow
              if ($missing -contains 'hash.txt') {
                "# Hashes placeholder ‚Äî generated by workflow`n# Actual hashes should be provided by ModManager during release creation" | Out-File -FilePath $hashFile -Encoding UTF8 -Force
              }
              if ($missing -contains 'README.md') {
                @(
                  "# Modpack ${v}",
                  "",
                  "This README was generated as a fallback by the CI workflow.",
                  "For full instructions, see the project's documentation.",
                  "",
                  "Contents:",
                  "- mods/ (mandatory)",
                  "- mods/optional/ (optional)",
                  "- server JARs (minecraft_server*, fabric-server*, installer)"
                ) | Out-File -FilePath $readmeFile -Encoding UTF8 -Force
              }
            }
          }
      
      - name: Package Modpacks
        shell: pwsh
        run: |
          Write-Host "üì¶ Packaging modpacks..." -ForegroundColor Cyan
          $releaseDirs = Get-ChildItem -Path "releases" -Directory
          foreach ($dir in $releaseDirs) {
            $ver = $dir.Name
            Write-Host "  Processing $ver" -ForegroundColor Yellow
            $zipPath = "modpack-$ver.zip"
            if (Test-Path $zipPath) {
              Remove-Item $zipPath -Force
            }
            Compress-Archive -Path "$($dir.FullName)\*" -DestinationPath $zipPath -Force
            Write-Host "    ‚úì Created $zipPath" -ForegroundColor Green
          }
          Write-Host "‚úÖ Packaging complete" -ForegroundColor Green
      
      - name: Generate Checksums
        shell: pwsh
        run: |
          $zipFiles = Get-ChildItem -Path "." -Filter "modpack-*.zip" -File
          if ($zipFiles.Count -eq 0) {
            Write-Host "No packaged ZIPs found; nothing to checksum." -ForegroundColor Red
            exit 1
          }
          Write-Host "üìê Computing SHA256 checksums..." -ForegroundColor Cyan
          $hashLines = @()
          foreach ($file in $zipFiles) {
            $hash = Get-FileHash -Path $file.FullName -Algorithm SHA256
            $hashLines += "$($hash.Hash)  $($file.Name)"
          }
          $hashLines | Out-File -FilePath "release-hashes.txt" -Encoding UTF8
          Write-Host "‚úì Wrote release-hashes.txt" -ForegroundColor Green
      
      - name: Collect README Files for Release Artifacts
        shell: pwsh
        run: |
          Write-Host "üìÑ Collecting README.md files from release directories..." -ForegroundColor Cyan
          # Clean up any leftover versioned README files from previous runs
          $oldReadmes = Get-ChildItem -Path "." -Filter "README-*.md" -File -ErrorAction SilentlyContinue
          if ($oldReadmes) {
            foreach ($old in $oldReadmes) {
              Remove-Item -Path $old.FullName -Force
              Write-Host "  üóëÔ∏è  Removed leftover: $($old.Name)" -ForegroundColor Gray
            }
          }
          $releaseDirs = Get-ChildItem -Path "releases" -Directory
          if ($releaseDirs.Count -eq 1) {
            # Single version - use README.md
            $dir = $releaseDirs[0]
            $readmeSrc = Join-Path $dir.FullName "README.md"
            $readmeDest = "README.md"
            
            if (Test-Path $readmeSrc) {
              Copy-Item -Path $readmeSrc -Destination $readmeDest -Force
              Write-Host "  ‚úì Copied README.md for version $($dir.Name) ‚Üí $readmeDest" -ForegroundColor Green
            } else {
              Write-Host "  ‚ö†Ô∏è  Warning: README.md not found for version $($dir.Name)" -ForegroundColor Yellow
            }
          } else {
            # Multiple versions - use versioned names
            foreach ($dir in $releaseDirs) {
              $ver = $dir.Name
              $readmeSrc = Join-Path $dir.FullName "README.md"
              $readmeDest = "README-$ver.md"
              
              if (Test-Path $readmeSrc) {
                Copy-Item -Path $readmeSrc -Destination $readmeDest -Force
                Write-Host "  ‚úì Copied README.md for version $ver ‚Üí $readmeDest" -ForegroundColor Green
              } else {
                Write-Host "  ‚ö†Ô∏è  Warning: README.md not found for version $ver" -ForegroundColor Yellow
              }
            }
          }
          Write-Host "‚úÖ README collection complete" -ForegroundColor Green
      
      - name: Generate Release Notes
        id: release_notes
        shell: pwsh
        run: |
          $TAG_NAME = "${{ steps.tag_info.outputs.tag_name }}"
          $VERSION = "${{ steps.tag_info.outputs.version }}"
          $TIMESTAMP = (Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC")
          
          $includedFiles = Get-ChildItem -Path "." -Filter "modpack-*.zip" -File
          
          $notes = @"
          # Minecraft Modpack Release - $TAG_NAME
          
          ## üì¶ Included Packages
          "@
          
          if ($includedFiles.Count -eq 0) {
            $notes += "`n- (none)"
          } else {
            foreach ($f in $includedFiles) {
              $notes += "`n- **$($f.Name)**"
            }
          }
          
          $notes += @"
          
          ## üìã Release Information
          - **Tag**: ``$TAG_NAME``
          - **Version**: $VERSION
          - **Created**: $TIMESTAMP
          - **Type**: Stable Release
          - **Validation**: Server startup tested for each packaged version
          
          ## üîë Checksums
          "@
          
          if (Test-Path "release-hashes.txt") {
            $notes += "`n``````"
            $notes += (Get-Content "release-hashes.txt" -Raw)
            $notes += "``````"
          } else {
            $notes += "`n(checksums unavailable)"
          }
          
          $notes += @"
          
          ## üì• Download Instructions
          
          1. Download ``modpack-[version].zip`` for your Minecraft version
          2. Extract the ZIP file
          3. Install mods from the ``mods/`` directory to ``.minecraft/mods/``
          4. Optional mods are in ``mods/optional/``
          5. Check ``hash.txt`` for file verification
          6. See ``README.md`` for complete installation guide
          
          ## üîó InertiaAntiCheat Integration
          
          Use included ``hash.txt`` to configure InertiaAntiCheat server validation.
          See ``README.md`` for details.
          "@
          
          $notes | Out-File -FilePath "release-notes.md" -Encoding UTF8
          Write-Host "Generated release-notes.md:" -ForegroundColor Cyan
          Get-Content "release-notes.md"
      
      - name: Clean Up Versioned README Files Before Release
        shell: pwsh
        run: |
          # Explicitly remove any versioned README files before creating release
          $versionedReadmes = Get-ChildItem -Path "." -Filter "README-*.md" -File -ErrorAction SilentlyContinue
          if ($versionedReadmes) {
            foreach ($file in $versionedReadmes) {
              Remove-Item -Path $file.FullName -Force
              Write-Host "üóëÔ∏è  Removed: $($file.Name)" -ForegroundColor Gray
            }
          }
          # Verify only README.md exists
          $readmeFiles = Get-ChildItem -Path "." -Filter "README*.md" -File -ErrorAction SilentlyContinue
          Write-Host "üìÑ README files in workspace:" -ForegroundColor Cyan
          foreach ($file in $readmeFiles) {
            Write-Host "  - $($file.Name)" -ForegroundColor $(if ($file.Name -eq "README.md") { "Green" } else { "Yellow" })
          }
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_info.outputs.tag_name }}
          name: Modpack Release ${{ steps.tag_info.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false  # Tag-based releases are stable
          files: |
            modpack-*.zip
            release-hashes.txt
            README.md
      
      - name: Release Summary
        shell: pwsh
        run: |
          $versionsJson = '${{ steps.set_versions.outputs.versions }}'
          $versions = ($versionsJson | ConvertFrom-Json)
          $versionsList = $versions -join ", "
          
          $summary = @"
          ## ‚úÖ Tag-Based Release Complete
          
          **Tag**: ``${{ steps.tag_info.outputs.tag_name }}``
          **Version**: ${{ steps.tag_info.outputs.version }}
          **Release Type**: Stable Release
          **Created**: $((Get-Date).ToUniversalTime().ToString("yyyy-MM-dd HH:mm:ss UTC"))
          
          **Included Versions**: $versionsList
          "@
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding UTF8

