name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual triggering
    inputs:
      testFiles:
        description: 'Comma-separated test files to run (e.g., 17-TestErrorHandling.ps1,68-TestServerValidation.ps1,96-TestCreateRelease.ps1). Leave empty to run all.'
        required: false
        default: ''

permissions:
  contents: write
  actions: read
  packages: write

jobs:
  test:
    name: Run Test Suite
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
      fail-fast: false # Continue running other OS tests even if one fails
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install PowerShell (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        # Download the Microsoft repository GPG keys
        wget -q "https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb"
        sudo dpkg -i packages-microsoft-prod.deb
        rm packages-microsoft-prod.deb
        
        # Update the list of packages
        sudo apt-get update
        
        # Install PowerShell
        sudo apt-get install -y powershell
        
    - name: Install PowerShell (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Install PowerShell using Homebrew
        brew install --cask powershell
        
    - name: Display environment info
      shell: pwsh
      run: |
        Write-Host "PowerShell Version:"
        $PSVersionTable.PSVersion
        
        Write-Host "`nOperating System:"
        if ($IsWindows) { "Windows" }
        elseif ($IsLinux) { "Linux" }
        elseif ($IsMacOS) { "macOS" }
        
        Write-Host "`nCurrent Directory:"
        Get-Location
        
    - name: Install dependencies (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # Windows-specific setup
        Write-Host "Setting up Windows environment..."
        
        # Ensure PowerShell execution policy allows script execution
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        
        Write-Host "Windows environment setup complete"
        
    - name: Install dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      shell: pwsh
      run: |
        # Linux-specific setup
        Write-Host "Setting up Linux environment..."
        
        # Install any required packages
        sudo apt-get update
        sudo apt-get install -y curl wget unzip
        
        Write-Host "Linux environment setup complete"
        
    - name: Install dependencies (macOS)
      if: matrix.os == 'macos-latest'
      shell: pwsh
      run: |
        # macOS-specific setup
        Write-Host "Setting up macOS environment..."
        
        # Install any required packages via Homebrew if needed
        if (Get-Command brew -ErrorAction SilentlyContinue) {
          Write-Host "Homebrew is available"
        } else {
          Write-Host "Homebrew not found, skipping package installation"
        }
        
        Write-Host "macOS environment setup complete"

    - name: Resolve test selection (optional)
      shell: pwsh
      run: |
        # Detect ci-artifacts/test-selection.txt and expose as TEST_FILES for the runner
        if (Test-Path 'ci-artifacts/test-selection.txt') {
          $list = Get-Content 'ci-artifacts/test-selection.txt' | ForEach-Object { $_.Trim() } | Where-Object { $_ -and ($_ -notmatch '^#') }
          if ($list -and $list.Count -gt 0) {
            Write-Host "Detected test-selection.txt: $($list -join ', ')" -ForegroundColor Green
            $joined = ($list -join ',')
            "TEST_FILES=$joined" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          } else {
            Write-Host "test-selection.txt is present but empty; will run full suite" -ForegroundColor Yellow
          }
        } else {
          Write-Host "No ci-artifacts/test-selection.txt found; will run full suite" -ForegroundColor Yellow
        }
        
    - name: Run test suite
      shell: pwsh
      env:
        CURSEFORGE_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
        MINECRAFT_SERVER_URL: https://piston-meta.mojang.com/mc/game/version_manifest_v2.json
        FABRIC_SERVER_URL: https://meta.fabricmc.net/v2/versions
        TEST_FILES: ${{ env.TEST_FILES }}
      run: |
        $ErrorActionPreference = 'Stop'
        Write-Host "============================================================================" -ForegroundColor Cyan
        Write-Host "TEST SUITE EXECUTION - DETAILED LOGGING" -ForegroundColor Cyan
        Write-Host "============================================================================" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "üìä ENVIRONMENT STATUS:" -ForegroundColor Yellow
        Write-Host "  OS: ${{ matrix.os }}"
        Write-Host "  PowerShell: $($PSVersionTable.PSVersion)"
        Write-Host "  Working Directory: $(Get-Location)"
        Write-Host "  Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Write-Host ""
        Write-Host "üîë API KEY STATUS:" -ForegroundColor Yellow
        if ($env:CURSEFORGE_API_KEY) {
          Write-Host "  API key present (length: $($env:CURSEFORGE_API_KEY.Length))" -ForegroundColor Green
        } else {
          Write-Host "  API key missing" -ForegroundColor Red
        }
        Write-Host "üìÅ FILE SYSTEM CHECK:" -ForegroundColor Yellow
        Write-Host "  Test dir: $(Test-Path 'test')"
        Write-Host "  RunAllTests.ps1: $(Test-Path 'test/RunAllTests.ps1')"
        Write-Host "  ModManager.ps1: $(Test-Path 'ModManager.ps1')"
        Write-Host "  ci-artifacts selection file: $(Test-Path 'ci-artifacts/test-selection.txt')"
        Write-Host "  TEST_FILES env: '$env:TEST_FILES'"
        Write-Host ""
        Write-Host "============================================================================" -ForegroundColor Cyan
        Write-Host "STARTING TEST EXECUTION" -ForegroundColor Cyan
        Write-Host "============================================================================" -ForegroundColor Cyan
        Write-Host ""
        Set-Location test
        $testFilesInput = '${{ github.event.inputs.testFiles }}'
        if ($testFilesInput -and $testFilesInput.Trim() -ne '') {
          Write-Host "Running workflow input tests: $testFilesInput" -ForegroundColor Green
          $list = $testFilesInput.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { $_ }
          .\RunAllTests.ps1 -TestFiles $list
        } elseif ($env:TEST_FILES) {
          Write-Host "Running tests from TEST_FILES env: $env:TEST_FILES" -ForegroundColor Green
          .\RunAllTests.ps1
        } else {
          Write-Host "Running full suite (no selection provided)" -ForegroundColor Yellow
          .\RunAllTests.ps1
        }
        $code = $LASTEXITCODE
        Write-Host "============================================================================" -ForegroundColor Cyan
        Write-Host "TEST EXECUTION COMPLETED (ExitCode=$code)" -ForegroundColor Cyan
        Write-Host "============================================================================" -ForegroundColor Cyan
        if ($code -ne 0) { exit $code }
        
    - name: Generate test summary report
      if: always()
      shell: pwsh
      run: |
        # Change to test directory and generate summary
        Set-Location test
        .\GenerateTestSummary.ps1 -OS "${{ matrix.os }}" -OutputFile "../test-summary-${{ matrix.os }}.md"
        
    - name: Generate comprehensive test results
      if: always()
      shell: pwsh
      run: |
        # Change to test directory and generate comprehensive results
        Set-Location test
        .\GenerateTestResults.ps1 -OS "${{ matrix.os }}" -OutputDir "../test-results-${{ matrix.os }}"
        
    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-${{ matrix.os }}
        path: |
          test/test-output/test-run-*.log
          test/test-output/*/*.log
        retention-days: 30
        
    - name: Upload test output directories
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-output-${{ matrix.os }}
        path: |
          test/test-output/
          test/output-*/
        retention-days: 30
        
    - name: Upload test summary report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-summary-${{ matrix.os }}
        path: |
          test-summary-${{ matrix.os }}.md
          test-results-${{ matrix.os }}/
          test/test-output/*/test-report.txt
          test/test-output/*/*-test-report.txt
        retention-days: 30
        
    - name: Upload test results CSV
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-csv-${{ matrix.os }}
        path: |
          test-results-${{ matrix.os }}/*.csv
          test/test-output/*/run-test-cli.csv
          test/output-*/run-test-cli.csv
        retention-days: 30
        
    - name: Upload test results JSON
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-json-${{ matrix.os }}
        path: |
          test-results-${{ matrix.os }}/*.json
        retention-days: 30
        
    - name: Upload mod download results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mod-download-results-${{ matrix.os }}
        path: |
          test/apiresponse/mod-download-results.csv
          test/test-output/*/modlist.csv
        retention-days: 30
        
    - name: Upload server startup logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: server-logs-${{ matrix.os }}
        path: |
          test/test-output/*/Server_*.log
          test/test-output/*/server.log
          test/test-output/*/logs/
        retention-days: 30
        
    - name: Upload test artifacts (comprehensive)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: all-test-artifacts-${{ matrix.os }}
        path: |
          test/test-output/
          test/output-*/
          test/apiresponse/
          test-summary-${{ matrix.os }}.md
          test-results-${{ matrix.os }}/
        retention-days: 30
        if-no-files-found: warn
        
    - name: Create test completion report
      if: always()
      shell: pwsh
      run: |
        # Create a simple completion report
        Set-Location test
        .\CreateCompletionReport.ps1 -OS "${{ matrix.os }}" -OutputFile "../test-completion-${{ matrix.os }}.txt"

  release:
    name: Create Release
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
    
    permissions:
      contents: write
      actions: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Generate release notes
      shell: pwsh
      run: |
        # Generate comprehensive release notes from actual test results
        Set-Location test
        .\GenerateReleaseNotes.ps1 -OutputFile "../RELEASE_NOTES.md" -ArtifactsPath "../artifacts"
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: test-release-${{ github.run_number }}
        name: Test Release ${{ github.run_number }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: true
        files: |
          artifacts/**/*
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 