name: Test Release Creation

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Minecraft version to test (e.g., 1.21.8)'
        required: true
        type: string
        default: '1.21.8'
      skip_validation:
        description: 'Skip server validation (faster but less thorough)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: read

jobs:
  test-release:
    runs-on: windows-latest
    timeout-minutes: 120
    env:
      CURSEFORGE_API_KEY: ${{ secrets.CURSEFORGE_API_KEY }}
      MINECRAFT_SERVER_URL: ${{ secrets.MINECRAFT_SERVER_URL }}
      FABRIC_SERVER_URL: ${{ secrets.FABRIC_SERVER_URL }}
    
    steps:
      - name: Checkout Repository with Submodules
        uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Display Test Configuration
        shell: pwsh
        run: |
          Write-Host "üß™ Test Release Creation" -ForegroundColor Cyan
          Write-Host "=========================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Version: ${{ github.event.inputs.version }}" -ForegroundColor Yellow
          Write-Host "Skip Validation: ${{ github.event.inputs.skip_validation }}" -ForegroundColor Yellow
          Write-Host ""
      
      - name: Create Release Package
        id: create_release
        shell: pwsh
        continue-on-error: true
        run: |
          $version = "${{ github.event.inputs.version }}"
          Write-Host "üöÄ Creating test release package for Minecraft $version" -ForegroundColor Cyan
          Write-Host "=================================================" -ForegroundColor Cyan
          Write-Host ""
          
          # Create release (this will download mods, validate server, generate hashes/README)
          if ("${{ github.event.inputs.skip_validation }}" -eq "true") {
            Write-Host "‚ö†Ô∏è  Skipping server validation (test mode)" -ForegroundColor Yellow
            # Note: -CreateRelease always validates, so we'd need a different approach
            # For now, we'll let it run normally but note that validation happens
          }
          
          .\ModManager.ps1 -CreateRelease -GameVersion $version
          
          $exitCode = $LASTEXITCODE
          if ($exitCode -eq 0) {
            Write-Host "‚úÖ Release creation completed successfully" -ForegroundColor Green
            echo "created=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "‚ùå Release creation failed (exit code: $exitCode)" -ForegroundColor Red
            echo "created=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Verify Release Files
        if: steps.create_release.outputs.created == 'true'
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          $releasePath = "releases/$version"
          
          Write-Host "üìã Verifying release files..." -ForegroundColor Cyan
          
          $hashFile = Join-Path $releasePath 'hash.txt'
          $readmeFile = Join-Path $releasePath 'README.md'
          $modsPath = Join-Path $releasePath 'mods'
          
          $missing = @()
          if (-not (Test-Path $hashFile)) { $missing += 'hash.txt' }
          if (-not (Test-Path $readmeFile)) { $missing += 'README.md' }
          if (-not (Test-Path $modsPath)) { $missing += 'mods/' }
          
          if ($missing.Count -eq 0) {
            Write-Host "‚úÖ All required files present" -ForegroundColor Green
            
            # Show file sizes
            if (Test-Path $hashFile) {
              $hashSize = (Get-Item $hashFile).Length
              Write-Host "  hash.txt: $hashSize bytes" -ForegroundColor Gray
            }
            if (Test-Path $readmeFile) {
              $readmeSize = (Get-Item $readmeFile).Length
              $readmeLines = (Get-Content $readmeFile).Count
              Write-Host "  README.md: $readmeSize bytes ($readmeLines lines)" -ForegroundColor Gray
            }
            if (Test-Path $modsPath) {
              $modCount = (Get-ChildItem -Path $modsPath -Filter '*.jar' -Recurse -File -ErrorAction SilentlyContinue).Count
              Write-Host "  mods/: $modCount JAR files" -ForegroundColor Gray
            }
          } else {
            Write-Host "‚ùå Missing required files: $($missing -join ', ')" -ForegroundColor Red
            exit 1
          }
      
      - name: Extract README for Artifact
        if: steps.create_release.outputs.created == 'true'
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          $releasePath = "releases/$version"
          $readmeSrc = Join-Path $releasePath 'README.md'
          $readmeDest = "README-${version}.md"
          
          if (Test-Path $readmeSrc) {
            Copy-Item -Path $readmeSrc -Destination $readmeDest -Force
            Write-Host "‚úì Extracted README.md ‚Üí $readmeDest" -ForegroundColor Green
            $fileInfo = Get-Item $readmeDest
            Write-Host "  Size: $($fileInfo.Length) bytes" -ForegroundColor Gray
          } else {
            Write-Host "‚ö†Ô∏è  README.md not found at $readmeSrc" -ForegroundColor Yellow
          }
      
      - name: Package Modpack ZIP
        if: steps.create_release.outputs.created == 'true'
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          $releasePath = "releases/$version"
          $zipPath = "modpack-${version}.zip"
          
          Write-Host "üì¶ Creating modpack ZIP..." -ForegroundColor Cyan
          
          # Remove existing ZIP if present
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          
          # Get all files to include (exclude certain patterns)
          $excludePatterns = @('*.zip', '*reconcile-*', '*expected-release-files.txt', '*actual-release-files.txt', '*verification-*.txt')
          $itemsToArchive = Get-ChildItem -Path $releasePath -Recurse -ErrorAction SilentlyContinue | Where-Object {
            $item = $_
            $shouldExclude = $false
            foreach ($pattern in $excludePatterns) {
              if ($item.FullName -like "*$pattern*" -or $item.Name -like $pattern) {
                $shouldExclude = $true
                break
              }
            }
            -not $shouldExclude
          }
          
          if ($itemsToArchive.Count -gt 0) {
            $paths = $itemsToArchive | ForEach-Object { $_.FullName }
            Compress-Archive -Path $paths -DestinationPath $zipPath -Force
            $zipInfo = Get-Item $zipPath
            $zipSizeMB = [math]::Round($zipInfo.Length / 1MB, 2)
            Write-Host "‚úì Created $zipPath ($zipSizeMB MB)" -ForegroundColor Green
          } else {
            Write-Host "‚ùå No files to archive" -ForegroundColor Red
            exit 1
          }
      
      - name: Generate Checksum
        if: steps.create_release.outputs.created == 'true'
        shell: pwsh
        run: |
          $version = "${{ github.event.inputs.version }}"
          $zipPath = "modpack-${version}.zip"
          $hashPath = "release-hash-${version}.txt"
          
          if (Test-Path $zipPath) {
            Write-Host "üìê Computing SHA256 checksum..." -ForegroundColor Cyan
            $hash = Get-FileHash -Path $zipPath -Algorithm SHA256
            $hashLine = "$($hash.Hash)  $zipPath"
            $hashLine | Out-File -FilePath $hashPath -Encoding UTF8 -NoNewline
            Write-Host "‚úì Checksum:" -ForegroundColor Green
            Write-Host $hashLine -ForegroundColor Gray
          }
      
      - name: Upload Release Directory Artifact
        if: steps.create_release.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.event.inputs.version }}-directory
          path: releases/${{ github.event.inputs.version }}/**
          retention-days: 7
          compression-level: 0
      
      - name: Upload Modpack ZIP Artifact
        if: steps.create_release.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: modpack-${{ github.event.inputs.version }}-zip
          path: modpack-${{ github.event.inputs.version }}.zip
          retention-days: 7
      
      - name: Upload README Artifact
        if: steps.create_release.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: readme-${{ github.event.inputs.version }}
          path: README-${{ github.event.inputs.version }}.md
          retention-days: 7
          if-no-files-found: warn
      
      - name: Upload Checksum Artifact
        if: steps.create_release.outputs.created == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: checksum-${{ github.event.inputs.version }}
          path: release-hash-${{ github.event.inputs.version }}.txt
          retention-days: 7
          if-no-files-found: warn
      
      - name: Test Summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          ## üß™ Test Release Creation Summary
          
          **Version**: ${{ github.event.inputs.version }}
          **Status**: ${{ steps.create_release.outcome }}
          
          "@
          
          if ("${{ steps.create_release.outcome }}" -eq "success") {
            $summary += @"
          ‚úÖ **Release created successfully**
          
          **Artifacts uploaded:**
          - Release directory (full contents)
          - Modpack ZIP file
          - README.md (extracted)
          - SHA256 checksum
          
          üí° **Note**: This is a test run. No GitHub Release was created.
          "@
          } else {
            $summary += @"
          ‚ùå **Release creation failed**
          
          Check the logs above for error details.
          "@
          }
          
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append

