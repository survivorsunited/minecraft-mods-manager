# Release Packaging Expectations and Directory Contract

This document defines exactly what must happen when creating a release package and what files are expected, where they go, and what is included in the modpack ZIP. The CSV (`modlist.csv`) is the source of truth.

## Inputs (source of truth)

- `modlist.csv` with at least the following columns (see `docs/MODLIST_CSV_COLUMNS.md` for full reference):
  - `Type`: `mod`, `datapack`, `shaderpack`, `server`, `launcher`, `installer`
  - `Group`: `required`, `optional`, `admin`, `block`
  - `ClientSide`: `required`, `optional`, `unsupported`
  - `ServerSide`: `required`, `optional`, `unsupported`
  - `CurrentGameVersion` (or target version derived via flags)
  - `Jar` and version URLs
- Cache folder: `download/<version>/` (mods, shaderpacks, datapacks, and server files). If files are missing, they MUST be downloaded automatically during release creation.

## Outputs (directory contract)

Release output directory (timestamped):

```text
releases/<version>/<YYYYMMDD-HHMMSS>/
  mods/                     # client-facing required mods
  mods/optional/            # client-facing optional mods
  mods/server/              # server-only mods and server-side helpers (not in ZIP)
  shaderpacks/              # client shaderpacks (zip/jar)
  datapacks/                # datapack ZIPs only
  hash.txt                  # generated by hash tool
  README.md                 # generated by hash tool
  modpack.zip               # packaged archive (see contents below)
  minecraft_server*.jar     # server JAR (outside ZIP, if available)
  fabric-server*.jar        # fabric server launcher (outside ZIP, if available)
  fabric-installer-*.exe    # installer (outside ZIP, if available)
  expected-release-files.txt
  actual-release-files.txt
  verification-missing.txt  # empty if none
  verification-extra.txt    # empty if none
```

### What goes into `modpack.zip`

The ZIP MUST contain ONLY client-facing content:

- `mods/`              → required client-facing mods (Type=mod)
- `mods/optional/`     → optional client-facing mods (Type=mod)
- `shaderpacks/`       → all shaderpacks (Type=shaderpack)
- `datapacks/`         → datapack ZIPs only (Type=datapack with .zip artifacts)

The ZIP MUST NOT contain:

- `mods/server/`       → server-only mods must be excluded from ZIP
- server JARs/launchers/installers → kept alongside release folder, not in ZIP

## Classification rules (client-facing vs server-only)

Use these rules to decide where an item is placed in the release structure:

1. Type = `mod`
   - If `ClientSide` is not `unsupported`: treat as client-facing
     - `Group = required` → `mods/`
     - `Group = optional` → `mods/optional/`
   - If `ClientSide` is `unsupported` (i.e., server-only) OR `Group = admin`:
     - Place under `mods/server/`
   - `Group = block`: exclude from release entirely

2. Type = `shaderpack`
   - Place in `shaderpacks/` (ZIP or JAR)
   - Always included in `modpack.zip`

3. Type = `datapack`
   - If file is `.jar`: treat as a client-facing mod (policy) → place under `mods/` or `mods/optional/` based on `Group`
   - If file is `.zip`: place under `datapacks/` (included in ZIP)

4. Server/Launcher/Installer entries (Type = `server`, `launcher`, `installer`)
   - Do not go into any `mods/` folder
   - Copy to the release directory root (outside the ZIP) if available in cache

## Mandatory behavior during release creation

1. Resolve target version (Current by default unless flags select Next/Latest/explicit).
2. Ensure cache is populated for the target version:
   - Download any missing artifacts to `download/<version>/...` before organizing.
3. Organize content into the release directory using the classification rules above.
4. Generate expected list from CSV and actual list from the created release directory.
5. Verify expected vs actual using relaxed-version pairing:
   - Missing files: 0 tolerated for client-facing content.
   - Version-only differences (same base mod name, different versions) are allowed but logged as warnings.
6. Package using the hash tool to create `hash.txt`, `README.md`, and `modpack.zip`.
   - The ZIP MUST include only the client-facing content listed above.
   - `mods/server/` MUST be excluded from ZIP.
7. Copy server files (if cached) to the release directory (outside the ZIP):
   - `minecraft_server*.jar`, `fabric-server*.jar`, and `installer/fabric-installer-*.exe` (if present).

## Success criteria (must-haves)

- Every client-facing mod expected by `modlist.csv` for the target version is present in the release under `mods/` or `mods/optional/` and is included in the ZIP.
- No server-only mods are included in `modpack.zip`; all server-only items are placed under `mods/server/`.
- Shaderpacks and datapacks (ZIPs) are present in their folders and included in the ZIP.
- `hash.txt`, `README.md`, and `modpack.zip` exist.
- `verification-missing.txt` is empty for client-facing content.

## Warnings and diagnostics (must log but not fail)

- ZIP artifacts detected under `mods/` (likely misclassification in DB)
- Version-only differences reconciled (expected `x-y-1.2.3.jar` vs actual `x-y-1.2.4.jar`)
- Datapack JARs mapped into `mods/` (policy reminder)

## Edge cases and expectations

- If a file is missing from cache, the release creation MUST download it automatically before packaging.
- If `Group` is unrecognized, default to `required` for `Type=mod`; for anything that resolves to server-only (ClientSide=unsupported or Group=admin), place under `mods/server/`.
- `Group = block` excludes the entry from client ZIP and from `mods/` entirely; if it’s server-supporting and needed by server ops, it may be placed under `mods/server/`.

## Quick check (what a correct release looks like)

- `releases/<version>/<stamp>/modpack.zip` exists and, when opened, contains only:
  - `mods/` (required), `mods/optional/` (optional), `shaderpacks/`, and `datapacks/`
  - No `mods/server/` path inside the ZIP
- `releases/<version>/<stamp>/mods/server/` contains server-only mods (if any), not included in ZIP
- `hash.txt` and `README.md` exist alongside the ZIP
- Server JARs/installer exist next to the ZIP (if cached)

## Verification checklist before publishing

- [ ] `verification-missing.txt` is empty (no missing client-facing items)
- [ ] `verification-extra.txt` contains only acceptable drift or extras; investigate unexpected server mods under `mods/`
- [ ] No ZIP files are present under `mods/` in the release directory (indicates DB misclassification)
- [ ] `modpack.zip` excludes `mods/server/`
- [ ] Shaderpacks and datapacks present and zipped as expected
